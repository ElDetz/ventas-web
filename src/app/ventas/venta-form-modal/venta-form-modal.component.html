<h2 class="modal-title">{{ editando ? 'Editar Venta' : 'Nueva Venta' }}</h2>
<form [formGroup]="ventaForm" (ngSubmit)="guardarVenta()" class="venta-form">
  <div class="venta-main-row">
    <mat-form-field appearance="fill" class="venta-field">
      <mat-label>Usuario</mat-label>
      <input type="text" matInput [matAutocomplete]="autoUsuario" (input)="onUsuarioInput($event)" [value]="getNombreUsuarioSeleccionado()" required>
      <mat-autocomplete #autoUsuario="matAutocomplete" (optionSelected)="ventaForm.patchValue({usuarioId: $event.option.value})">
        <mat-option *ngFor="let u of usuarioFiltrado" [value]="u.id">{{u.nombre}}</mat-option>
      </mat-autocomplete>
      <mat-error *ngIf="!ventaForm.value.usuarioId">Seleccione un usuario</mat-error>
    </mat-form-field>
    <mat-form-field appearance="fill" class="venta-field">
      <mat-label>Fecha Venta</mat-label>
      <input matInput formControlName="fechaVenta" type="date" required>
      <mat-error *ngIf="ventaForm.get('fechaVenta')?.invalid && ventaForm.get('fechaVenta')?.touched">Ingrese una fecha válida</mat-error>
    </mat-form-field>
    <mat-form-field appearance="fill" class="venta-field">
      <mat-label>Total</mat-label>
      <input matInput [value]="ventaForm.value.total | number:'1.2-2'" readonly>
    </mat-form-field>
  </div>

  <h3 class="detalle-title">Agregar Detalle</h3>
  <div class="detalle-form-row compact">
    <mat-form-field appearance="fill" class="detalle-field">
      <mat-label>Producto</mat-label>
      <input type="text" matInput [matAutocomplete]="autoProducto" placeholder="Buscar producto" [(ngModel)]="filtroProducto" (input)="onProductoInput($event)" [ngModelOptions]="{standalone: true}">
      <mat-autocomplete #autoProducto="matAutocomplete" (optionSelected)="onProductoSeleccionado($event.option.value)">
        <mat-option *ngFor="let p of productosFiltrados" [value]="p.id">{{p.nombre}}</mat-option>
      </mat-autocomplete>
      <mat-error *ngIf="!detalleActual.productoId">Seleccione un producto</mat-error>
    </mat-form-field>
    <mat-form-field appearance="fill" class="detalle-field">
      <mat-label>Cantidad</mat-label>
      <input matInput type="number" min="1" [(ngModel)]="detalleActual.cantidad" name="cantidad" required (input)="onCantidadChange()" [ngModelOptions]="{standalone: true}">
      <mat-error *ngIf="!detalleActual.cantidad || detalleActual.cantidad < 1">Ingrese una cantidad válida</mat-error>
    </mat-form-field>
    <mat-form-field appearance="fill" class="detalle-field">
      <mat-label>Precio</mat-label>
      <input matInput [value]="getPrecioProductoSeleccionado() | number:'1.2-2'" readonly>
    </mat-form-field>
    <button mat-mini-fab color="primary" type="button" (click)="agregarDetalle()" [disabled]="!detalleActual.productoId || detalleActual.cantidad < 1">
      <mat-icon>add</mat-icon>
    </button>
  </div>

  <table mat-table [dataSource]="detallesVenta" class="mat-elevation-z8 full-width-table" *ngIf="detallesVenta.length" [trackBy]="trackByIndex">
    <ng-container matColumnDef="producto">
      <th mat-header-cell *matHeaderCellDef>Producto</th>
      <td mat-cell *matCellDef="let d">{{d.producto?.nombre}}</td>
    </ng-container>
    <ng-container matColumnDef="cantidad">
      <th mat-header-cell *matHeaderCellDef>Cantidad</th>
      <td mat-cell *matCellDef="let d">{{d.cantidad}}</td>
    </ng-container>
    <ng-container matColumnDef="precio">
      <th mat-header-cell *matHeaderCellDef>Precio</th>
      <td mat-cell *matCellDef="let d">{{d.precio | number:'1.2-2'}}</td>
    </ng-container>
    <ng-container matColumnDef="subtotal">
      <th mat-header-cell *matHeaderCellDef>Subtotal</th>
      <td mat-cell *matCellDef="let d">{{(d.cantidad * d.precio) | number:'1.2-2'}}</td>
    </ng-container>
    <ng-container matColumnDef="acciones">
      <th mat-header-cell *matHeaderCellDef>Acciones</th>
      <td mat-cell *matCellDef="let d; let i = index">
        <button mat-icon-button color="warn" (click)="eliminarDetalle(i)">
          <mat-icon>delete</mat-icon>
        </button>
      </td>
    </ng-container>
    <tr mat-header-row *matHeaderRowDef="['producto','cantidad','precio','subtotal','acciones']"></tr>
    <tr mat-row *matRowDef="let row; columns: ['producto','cantidad','precio','subtotal','acciones'];"></tr>
  </table>

  <div class="modal-actions">
    <button mat-raised-button color="primary" type="submit" [disabled]="ventaForm.invalid || !detallesVenta.length">
      <mat-icon>{{ editando ? 'edit' : 'save' }}</mat-icon> {{ editando ? 'Actualizar' : 'Guardar' }}
    </button>
    <button mat-stroked-button color="warn" type="button" (click)="cerrar()">
      <mat-icon>close</mat-icon> Cancelar
    </button>
  </div>
</form>
